<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WA Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0a0a0a;
      --surface: #131313;
      --surface2: #1a1a1a;
      --border: #242424;
      --accent: #25d366;
      --red: #ff4d4d;
      --yellow: #f5a623;
      --blue: #4da6ff;
      --text: #efefef;
      --muted: #555;
      --r: 12px;
    }
    body { font-family: 'Syne', sans-serif; background: var(--bg); color: var(--text); display: flex; min-height: 100vh; }

    /* â”€â”€ Sidebar â”€â”€ */
    .sidebar {
      width: 230px; min-height: 100vh; position: fixed; top: 0; left: 0;
      background: var(--surface); border-right: 1px solid var(--border);
      display: flex; flex-direction: column; padding: 24px 0;
    }
    .logo { padding: 0 20px 28px; display: flex; align-items: center; gap: 10px; }
    .logo-icon { width: 34px; height: 34px; background: var(--accent); border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 17px; }
    .logo-text { font-size: 17px; font-weight: 800; letter-spacing: -0.4px; }

    .nav-section { padding: 0 12px; margin-bottom: 4px; }
    .nav-label { font-size: 10px; font-weight: 700; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; padding: 0 8px 8px; margin-top: 16px; display: block; }
    .nav-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; border-radius: 8px; cursor: pointer;
      color: var(--muted); font-size: 13px; font-weight: 600;
      transition: all 0.12s; letter-spacing: 0.2px;
    }
    .nav-item:hover { color: var(--text); background: var(--surface2); }
    .nav-item.active { color: var(--text); background: var(--surface2); }
    .nav-item.active .nav-dot { background: var(--accent); }
    .nav-dot { width: 6px; height: 6px; border-radius: 50%; background: transparent; margin-left: auto; flex-shrink: 0; }

    .sidebar-bottom { margin-top: auto; padding: 16px 20px 0; border-top: 1px solid var(--border); }
    .wa-pill {
      display: flex; align-items: center; gap: 10px;
      padding: 12px 14px; border-radius: 10px;
      background: var(--surface2); border: 1px solid var(--border);
    }
    .wa-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--muted); flex-shrink: 0; }
    .wa-dot.ready { background: var(--accent); box-shadow: 0 0 8px var(--accent); animation: glow 2s infinite; }
    .wa-dot.qr, .wa-dot.connecting { background: var(--yellow); animation: glow 1s infinite; }
    @keyframes glow { 0%,100%{opacity:1} 50%{opacity:0.4} }
    .wa-info { flex: 1; }
    .wa-label { font-size: 10px; color: var(--muted); font-weight: 700; letter-spacing: 0.8px; text-transform: uppercase; }
    .wa-val { font-size: 12px; font-weight: 700; margin-top: 2px; }
    .btn-logout { margin-top: 10px; width: 100%; background: none; border: 1px solid var(--border); color: var(--muted); border-radius: 8px; padding: 8px; font-family: 'Syne', sans-serif; font-size: 12px; cursor: pointer; transition: all 0.12s; }
    .btn-logout:hover { color: var(--text); border-color: var(--text); }

    /* â”€â”€ Main â”€â”€ */
    .main { margin-left: 230px; flex: 1; padding: 36px 40px; }
    .page { display: none; }
    .page.active { display: block; }
    .page-title { font-size: 26px; font-weight: 800; letter-spacing: -0.8px; margin-bottom: 4px; }
    .page-sub { color: var(--muted); font-size: 13px; margin-bottom: 32px; }

    /* â”€â”€ Stats grid â”€â”€ */
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 28px; }
    .stat {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--r); padding: 20px;
    }
    .stat-lbl { font-size: 10px; font-weight: 700; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 10px; }
    .stat-val { font-size: 34px; font-weight: 800; letter-spacing: -2px; line-height: 1; }
    .stat-val.green { color: var(--accent); }
    .stat-val.red { color: var(--red); }
    .stat-val.yellow { color: var(--yellow); }

    /* â”€â”€ Cards â”€â”€ */
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); padding: 22px; margin-bottom: 20px; }
    .card-title { font-size: 14px; font-weight: 700; margin-bottom: 16px; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }

    /* â”€â”€ Chart â”€â”€ */
    .chart { display: flex; align-items: flex-end; gap: 6px; height: 72px; }
    .bar-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 5px; height: 100%; }
    .bar { width: 100%; background: var(--accent); border-radius: 3px 3px 0 0; min-height: 2px; opacity: 0.75; transition: height 0.3s ease; }
    .bar-lbl { font-size: 9px; color: var(--muted); font-family: 'DM Mono', monospace; }

    /* â”€â”€ Table â”€â”€ */
    .tbl-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; padding: 8px 14px; font-size: 10px; font-weight: 700; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; border-bottom: 1px solid var(--border); }
    td { padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,0.025); font-family: 'DM Mono', monospace; font-size: 12px; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(255,255,255,0.015); }
    .empty-row { text-align: center; color: var(--muted); padding: 40px !important; font-family: 'Syne', sans-serif; }

    /* â”€â”€ Badges â”€â”€ */
    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 9px; border-radius: 20px; font-size: 10px; font-weight: 700; font-family: 'Syne', sans-serif; letter-spacing: 0.4px; white-space: nowrap; }
    .badge.sent, .badge.success { background: rgba(37,211,102,0.1); color: var(--accent); }
    .badge.error { background: rgba(255,77,77,0.1); color: var(--red); }
    .badge.pending { background: rgba(245,166,35,0.1); color: var(--yellow); }
    .badge.running { background: rgba(77,166,255,0.1); color: var(--blue); }
    .badge.active { background: rgba(37,211,102,0.1); color: var(--accent); }
    .badge.draft { background: rgba(255,255,255,0.05); color: var(--muted); }

    /* â”€â”€ Buttons â”€â”€ */
    .btn { display: inline-flex; align-items: center; gap: 7px; padding: 9px 18px; border-radius: 8px; font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; cursor: pointer; border: none; transition: all 0.12s; letter-spacing: 0.2px; }
    .btn-primary { background: var(--accent); color: #000; }
    .btn-primary:hover { background: #1fba58; transform: translateY(-1px); }
    .btn-ghost { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
    .btn-ghost:hover { border-color: #444; }
    .btn-danger { background: rgba(255,77,77,0.1); color: var(--red); border: 1px solid rgba(255,77,77,0.15); }
    .btn-danger:hover { background: rgba(255,77,77,0.18); }
    .btn-yellow { background: rgba(245,166,35,0.1); color: var(--yellow); border: 1px solid rgba(245,166,35,0.15); }
    .btn-yellow:hover { background: rgba(245,166,35,0.18); }
    .btn-sm { padding: 5px 10px; font-size: 11px; }
    .btn-xs { padding: 3px 8px; font-size: 10px; }
    .toolbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .toolbar-left { display: flex; align-items: center; gap: 10px; }
    .section-lbl { font-size: 13px; font-weight: 700; color: var(--muted); }

    /* â”€â”€ Forms â”€â”€ */
    .form-group { margin-bottom: 16px; }
    label.field-label { display: block; font-size: 10px; font-weight: 700; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; }
    input[type=text], input[type=number], input[type=time], input[type=datetime-local], textarea, select {
      width: 100%; background: var(--surface2); border: 1px solid var(--border);
      border-radius: 8px; padding: 10px 12px; color: var(--text);
      font-family: 'DM Mono', monospace; font-size: 13px; outline: none;
      transition: border-color 0.12s;
    }
    input:focus, textarea:focus, select:focus { border-color: #444; }
    textarea { resize: vertical; min-height: 90px; line-height: 1.5; }
    .hint { font-size: 11px; color: var(--muted); margin-top: 5px; font-family: 'DM Mono', monospace; line-height: 1.4; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .form-row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; }

    /* â”€â”€ Day picker â”€â”€ */
    .day-picker { display: flex; gap: 6px; }
    .day-btn {
      width: 34px; height: 34px; border-radius: 8px;
      background: var(--surface2); border: 1px solid var(--border);
      color: var(--muted); font-family: 'Syne', sans-serif; font-size: 11px;
      font-weight: 700; cursor: pointer; transition: all 0.12s;
    }
    .day-btn.on { background: rgba(37,211,102,0.15); border-color: rgba(37,211,102,0.3); color: var(--accent); }

    /* â”€â”€ Toggle â”€â”€ */
    .toggle-row { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
    .toggle { position: relative; width: 38px; height: 22px; cursor: pointer; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute; inset: 0; background: var(--border); border-radius: 22px;
      transition: background 0.2s;
    }
    .toggle-slider::before {
      content: ''; position: absolute; width: 16px; height: 16px;
      left: 3px; top: 3px; background: #fff; border-radius: 50%; transition: transform 0.2s;
    }
    .toggle input:checked ~ .toggle-slider { background: var(--accent); }
    .toggle input:checked ~ .toggle-slider::before { transform: translateX(16px); }
    .toggle-label { font-size: 13px; font-weight: 600; }

    /* â”€â”€ Modal â”€â”€ */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75); backdrop-filter: blur(6px); z-index: 200; align-items: center; justify-content: center; }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 30px; width: 560px; max-height: 85vh; overflow-y: auto; }
    .modal-title { font-size: 18px; font-weight: 800; letter-spacing: -0.4px; margin-bottom: 22px; display: flex; align-items: center; justify-content: space-between; }
    .modal-close { background: none; border: none; color: var(--muted); font-size: 20px; cursor: pointer; line-height: 1; padding: 0; }
    .modal-close:hover { color: var(--text); }
    .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 6px; }

    /* â”€â”€ Contacts select in modal â”€â”€ */
    .contacts-select { max-height: 180px; overflow-y: auto; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; }
    .contact-item { display: flex; align-items: center; gap: 10px; padding: 9px 12px; border-bottom: 1px solid rgba(255,255,255,0.03); cursor: pointer; font-size: 12px; }
    .contact-item:last-child { border-bottom: none; }
    .contact-item:hover { background: rgba(255,255,255,0.03); }
    .contact-item input[type=checkbox] { width: auto; flex-shrink: 0; accent-color: var(--accent); }
    .contact-name { font-weight: 600; font-family: 'Syne', sans-serif; font-size: 12px; }
    .contact-num { color: var(--muted); font-family: 'DM Mono', monospace; margin-left: auto; font-size: 11px; }

    /* â”€â”€ CSV upload â”€â”€ */
    .upload-zone {
      border: 2px dashed var(--border); border-radius: 10px;
      padding: 32px; text-align: center; cursor: pointer;
      transition: all 0.15s; margin-bottom: 16px;
    }
    .upload-zone:hover, .upload-zone.drag { border-color: var(--accent); background: rgba(37,211,102,0.04); }
    .upload-zone input { display: none; }
    .upload-icon { font-size: 32px; margin-bottom: 10px; }
    .upload-text { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
    .upload-sub { font-size: 12px; color: var(--muted); }
    .import-result { background: rgba(37,211,102,0.06); border: 1px solid rgba(37,211,102,0.15); border-radius: 8px; padding: 14px; font-size: 13px; display: none; }

    /* â”€â”€ QR â”€â”€ */
    .qr-wrap { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 0; gap: 20px; text-align: center; }
    .qr-img { border-radius: 14px; border: 6px solid var(--surface2); }
    .qr-title { font-size: 20px; font-weight: 800; }
    .qr-sub { font-size: 13px; color: var(--muted); max-width: 300px; line-height: 1.6; }
    .connected-box { display: flex; align-items: center; gap: 16px; background: rgba(37,211,102,0.06); border: 1px solid rgba(37,211,102,0.18); border-radius: var(--r); padding: 20px; margin-bottom: 24px; }
    .connected-icon { font-size: 30px; }
    .connected-title { font-size: 15px; font-weight: 700; }
    .connected-sub { font-size: 12px; color: var(--muted); margin-top: 2px; }

    /* â”€â”€ Variables helper â”€â”€ */
    .var-chips { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .var-chip { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 3px 10px; font-size: 11px; font-family: 'DM Mono', monospace; color: var(--accent); cursor: pointer; transition: all 0.12s; }
    .var-chip:hover { background: rgba(37,211,102,0.1); border-color: rgba(37,211,102,0.2); }

    /* â”€â”€ Progress bar â”€â”€ */
    .progress-wrap { background: var(--surface2); border-radius: 4px; height: 6px; overflow: hidden; }
    .progress-bar { height: 100%; background: var(--accent); border-radius: 4px; transition: width 0.3s ease; }

    .actions { display: flex; gap: 6px; }
    .text-muted { color: var(--muted); }
    .mt-4 { margin-top: 16px; }
    .truncate { max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  </style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar">
  <div class="logo">
    <div class="logo-icon">ğŸ’¬</div>
    <div class="logo-text">WA Dashboard</div>
  </div>

  <div class="nav-section">
    <span class="nav-label">Vue gÃ©nÃ©rale</span>
    <div class="nav-item active" data-page="analytics">
      <span>ğŸ“Š</span> Analytics
      <div class="nav-dot"></div>
    </div>
  </div>

  <div class="nav-section">
    <span class="nav-label">Envois</span>
    <div class="nav-item" data-page="contacts">
      <span>ğŸ‘¥</span> Contacts
      <div class="nav-dot"></div>
    </div>
    <div class="nav-item" data-page="campaigns">
      <span>ğŸ“¨</span> Campagnes
      <div class="nav-dot"></div>
    </div>
    <div class="nav-item" data-page="queue">
      <span>â³</span> File d'attente
      <div class="nav-dot"></div>
    </div>
    <div class="nav-item" data-page="logs">
      <span>ğŸ“‹</span> Historique
      <div class="nav-dot"></div>
    </div>
  </div>

  <div class="nav-section">
    <span class="nav-label">ParamÃ¨tres</span>
    <div class="nav-item" data-page="connection">
      <span>ğŸ”—</span> Connexion WA
      <div class="nav-dot"></div>
    </div>
  </div>

  <div class="sidebar-bottom">
    <div class="wa-pill">
      <div class="wa-dot" id="wa-dot"></div>
      <div class="wa-info">
        <div class="wa-label">WhatsApp</div>
        <div class="wa-val" id="wa-val">â€”</div>
      </div>
    </div>
    <button class="btn-logout" onclick="logout()">Se dÃ©connecter â†’</button>
  </div>
</aside>

<!-- Pages -->
<main class="main">

  <!-- â”€â”€ Analytics â”€â”€ -->
  <div class="page active" id="page-analytics">
    <div class="page-title">Analytics</div>
    <div class="page-sub">Suivi de tes envois WhatsApp</div>

    <div class="stats-row">
      <div class="stat">
        <div class="stat-lbl">EnvoyÃ©s aujourd'hui</div>
        <div class="stat-val green" id="s-today">â€”</div>
      </div>
      <div class="stat">
        <div class="stat-lbl">Total envoyÃ©s</div>
        <div class="stat-val green" id="s-total">â€”</div>
      </div>
      <div class="stat">
        <div class="stat-lbl">Taux de succÃ¨s</div>
        <div class="stat-val" id="s-rate" style="color:var(--accent)">â€”</div>
      </div>
      <div class="stat">
        <div class="stat-lbl">En attente</div>
        <div class="stat-val yellow" id="s-pending">â€”</div>
      </div>
    </div>

    <div class="grid2">
      <div class="card">
        <div class="card-title">Messages envoyÃ©s â€” 14 derniers jours</div>
        <div class="chart" id="chart"></div>
      </div>
      <div class="card">
        <div class="card-title">Par campagne</div>
        <div id="camp-stats"></div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Contacts â”€â”€ -->
  <div class="page" id="page-contacts">
    <div class="page-title">Contacts</div>
    <div class="page-sub">Importe ton CSV ou ajoute manuellement</div>

    <!-- Import CSV -->
    <div class="card">
      <div class="card-title">Importer un CSV</div>
      <div class="upload-zone" id="upload-zone" onclick="document.getElementById('csv-input').click()">
        <input type="file" id="csv-input" accept=".csv" onchange="handleCSV(this)" />
        <div class="upload-icon">ğŸ“‚</div>
        <div class="upload-text">Clique ou glisse ton fichier CSV ici</div>
        <div class="upload-sub">Colonnes requises : <code>name</code> (ou nom), <code>number</code> (ou numero)<br>Colonnes bonus : toute colonne devient une variable <code>{{colonne}}</code></div>
      </div>
      <div class="import-result" id="import-result"></div>
    </div>

    <div class="card">
      <div class="toolbar">
        <div class="toolbar-left">
          <div class="section-lbl" id="contacts-count">â€” contacts</div>
        </div>
        <div class="toolbar-left">
          <input type="text" id="contact-search" placeholder="Rechercher..." style="width:200px;padding:7px 10px;font-size:12px" oninput="filterContacts(this.value)" />
          <button class="btn btn-primary btn-sm" onclick="openModal('modal-contact')">+ Ajouter</button>
        </div>
      </div>
      <div class="tbl-wrap">
        <table>
          <thead><tr><th>Nom</th><th>NumÃ©ro</th><th>Champs custom</th><th>AjoutÃ© le</th><th></th></tr></thead>
          <tbody id="contacts-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Campaigns â”€â”€ -->
  <div class="page" id="page-campaigns">
    <div class="page-title">Campagnes</div>
    <div class="page-sub">CrÃ©e tes messages et configure la frÃ©quence d'envoi</div>

    <div class="toolbar">
      <div class="section-lbl" id="campaigns-count">â€” campagnes</div>
      <button class="btn btn-primary" onclick="openCampaignModal()">+ Nouvelle campagne</button>
    </div>

    <div id="campaigns-list"></div>
  </div>

  <!-- â”€â”€ Queue â”€â”€ -->
  <div class="page" id="page-queue">
    <div class="page-title">File d'attente</div>
    <div class="page-sub">Messages planifiÃ©s et en cours d'envoi</div>

    <div class="card">
      <div class="tbl-wrap">
        <table>
          <thead><tr><th>PlanifiÃ© pour</th><th>Contact</th><th>NumÃ©ro</th><th>Campagne</th><th>Statut</th></tr></thead>
          <tbody id="queue-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Logs â”€â”€ -->
  <div class="page" id="page-logs">
    <div class="page-title">Historique</div>
    <div class="page-sub">Tous les envois rÃ©cents</div>

    <div class="card">
      <div class="tbl-wrap">
        <table>
          <thead><tr><th>Date</th><th>Contact</th><th>NumÃ©ro</th><th>Campagne</th><th>Statut</th><th>Erreur</th></tr></thead>
          <tbody id="logs-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Connection â”€â”€ -->
  <div class="page" id="page-connection">
    <div class="page-title">Connexion WhatsApp</div>
    <div class="page-sub">Lie ton numÃ©ro au dashboard</div>
    <div id="connection-content"></div>
  </div>

</main>

<!-- â”€â”€ Modal: Contact â”€â”€ -->
<div class="modal-overlay" id="modal-contact">
  <div class="modal">
    <div class="modal-title">Nouveau contact <button class="modal-close" onclick="closeModal('modal-contact')">Ã—</button></div>
    <div class="form-row">
      <div class="form-group">
        <label class="field-label">PrÃ©nom / Nom</label>
        <input type="text" id="c-name" placeholder="Alice" />
      </div>
      <div class="form-group">
        <label class="field-label">NumÃ©ro</label>
        <input type="text" id="c-number" placeholder="0612345678" />
      </div>
    </div>
    <div class="hint" style="margin-bottom:16px">Format : 0612345678 ou 33612345678 (sans +)</div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-contact')">Annuler</button>
      <button class="btn btn-primary" onclick="addContact()">Ajouter</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Modal: Campaign â”€â”€ -->
<div class="modal-overlay" id="modal-campaign">
  <div class="modal">
    <div class="modal-title" id="modal-camp-title">Nouvelle campagne <button class="modal-close" onclick="closeModal('modal-campaign')">Ã—</button></div>

    <div class="form-group">
      <label class="field-label">Nom de la campagne</label>
      <input type="text" id="camp-name" placeholder="Relance clients janvier" />
    </div>

    <div class="form-group">
      <label class="field-label">Message</label>
      <textarea id="camp-message" placeholder="Salut {{name}}, ..."></textarea>
      <div class="hint">Variables disponibles selon ton CSV :</div>
      <div class="var-chips" id="var-chips">
        <div class="var-chip" onclick="insertVar('name')">{{name}}</div>
        <div class="var-chip" onclick="insertVar('number')">{{number}}</div>
      </div>
    </div>

    <div class="form-group">
      <label class="field-label">Contacts</label>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input type="text" id="camp-contact-search" placeholder="Filtrer les contacts..." style="font-size:12px;padding:7px 10px" oninput="filterCampContacts(this.value)" />
        <button class="btn btn-ghost btn-sm" onclick="toggleAllContacts(true)">Tous</button>
        <button class="btn btn-ghost btn-sm" onclick="toggleAllContacts(false)">Aucun</button>
      </div>
      <div class="contacts-select" id="camp-contact-list"></div>
      <div class="hint" id="selected-count">0 contact sÃ©lectionnÃ©</div>
    </div>

    <hr style="border:none;border-top:1px solid var(--border);margin:20px 0" />

    <div class="form-group">
      <label class="field-label">Mode d'envoi</label>
      <select id="camp-schedule-type" onchange="updateScheduleUI()">
        <option value="manual">Manuel (j'envoie quand je veux)</option>
        <option value="daily">Quotidien Ã  heure fixe</option>
        <option value="spread">Ã‰talÃ© sur la journÃ©e automatiquement</option>
      </select>
    </div>

    <div id="schedule-options" style="display:none">
      <div class="form-group">
        <label class="field-label">Limite quotidienne (max messages/jour)</label>
        <input type="number" id="camp-limit" value="10" min="1" max="50" />
      </div>

      <div class="form-group">
        <label class="field-label">Jours d'envoi</label>
        <div class="day-picker" id="day-picker">
          <button class="day-btn on" data-i="1">Lun</button>
          <button class="day-btn on" data-i="2">Mar</button>
          <button class="day-btn on" data-i="3">Mer</button>
          <button class="day-btn on" data-i="4">Jeu</button>
          <button class="day-btn on" data-i="5">Ven</button>
          <button class="day-btn" data-i="6">Sam</button>
          <button class="day-btn" data-i="0">Dim</button>
        </div>
      </div>

      <div id="fixed-time-opts">
        <div class="form-group">
          <label class="field-label">Heure d'envoi</label>
          <input type="time" id="camp-time" value="09:00" />
        </div>
      </div>

      <div id="spread-opts" style="display:none">
        <div class="form-row">
          <div class="form-group">
            <label class="field-label">DÃ©but de plage</label>
            <input type="time" id="camp-start" value="09:00" />
          </div>
          <div class="form-group">
            <label class="field-label">Fin de plage</label>
            <input type="time" id="camp-end" value="18:00" />
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-campaign')">Annuler</button>
      <button class="btn btn-primary" onclick="saveCampaign()" id="save-camp-btn">CrÃ©er la campagne</button>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allContacts = [], allCampaigns = [], editingCampId = null;
const $ = id => document.getElementById(id);
const fmt = d => d ? new Date(d).toLocaleString('fr-FR', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' }) : 'â€”';
const fmtDate = d => d ? d.slice(0, 10).split('-').reverse().join('/') : 'â€”';

// â”€â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(method, url, body) {
  const res = await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: body ? JSON.stringify(body) : undefined
  });
  if (res.status === 401) { window.location.href = '/login'; throw new Error('auth'); }
  return res.json();
}

async function apiForm(url, formData) {
  const res = await fetch(url, { method: 'POST', body: formData });
  if (res.status === 401) { window.location.href = '/login'; throw new Error('auth'); }
  return res.json();
}

// â”€â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const pageLoaders = {
  analytics: loadAnalytics,
  contacts: loadContacts,
  campaigns: loadCampaigns,
  queue: loadQueue,
  logs: loadLogs,
  connection: loadConnection
};

document.querySelectorAll('.nav-item').forEach(el => {
  el.addEventListener('click', () => {
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    el.classList.add('active');
    const page = el.dataset.page;
    $('page-' + page).classList.add('active');
    pageLoaders[page]?.();
  });
});

// â”€â”€â”€ WA Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const statusText = { disconnected: 'DÃ©connectÃ©', qr: 'QR en attente', connecting: 'Connexion...', ready: 'ConnectÃ© âœ“' };

async function pollWA() {
  try {
    const d = await api('GET', '/api/wa/status');
    $('wa-dot').className = 'wa-dot ' + d.status;
    $('wa-val').textContent = statusText[d.status] || d.status;
  } catch {}
}
setInterval(pollWA, 4000);
pollWA();

// â”€â”€â”€ Logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function logout() {
  await api('POST', '/api/logout');
  window.location.href = '/login';
}

// â”€â”€â”€ Analytics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAnalytics() {
  const d = await api('GET', '/api/analytics');

  $('s-today').textContent = d.today;
  $('s-total').textContent = d.total;
  $('s-pending').textContent = d.pending;

  const rate = (d.total + d.errors) > 0 ? Math.round((d.total / (d.total + d.errors)) * 100) : 0;
  $('s-rate').textContent = rate + '%';
  $('s-rate').style.color = rate >= 90 ? 'var(--accent)' : rate >= 70 ? 'var(--yellow)' : 'var(--red)';

  // Chart 14 jours
  const chart = $('chart');
  chart.innerHTML = '';
  const days = [];
  for (let i = 13; i >= 0; i--) {
    const dt = new Date(); dt.setDate(dt.getDate() - i);
    const key = dt.toISOString().slice(0, 10);
    const found = d.byDay.find(b => b.day === key);
    days.push({ day: key, count: found?.count || 0 });
  }
  const max = Math.max(...days.map(x => x.count), 1);
  days.forEach(({ day, count }) => {
    const pct = Math.round((count / max) * 100);
    chart.innerHTML += `<div class="bar-col">
      <div class="bar" style="height:${pct}%" title="${count} msg le ${day}"></div>
      <div class="bar-lbl">${day.slice(8)}</div>
    </div>`;
  });

  // By campaign
  const cs = $('camp-stats');
  if (!d.byCampaign?.length) { cs.innerHTML = '<div style="color:var(--muted);font-size:13px;padding:8px 0">Aucune donnÃ©e</div>'; return; }
  cs.innerHTML = d.byCampaign.map(c => `
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
      <div style="flex:1;font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${c.name}</div>
      <div style="width:120px"><div class="progress-wrap"><div class="progress-bar" style="width:${Math.round(c.sent/d.byCampaign[0].sent*100)}%"></div></div></div>
      <div style="font-size:12px;font-family:'DM Mono',monospace;color:var(--accent);width:28px;text-align:right">${c.sent}</div>
    </div>
  `).join('');
}

// â”€â”€â”€ Contacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let contactsFiltered = [];

async function loadContacts() {
  allContacts = await api('GET', '/api/contacts');
  contactsFiltered = [...allContacts];
  renderContacts();
  $('contacts-count').textContent = allContacts.length + ' contact' + (allContacts.length > 1 ? 's' : '');
}

function renderContacts() {
  const tbody = $('contacts-tbody');
  if (!contactsFiltered.length) {
    tbody.innerHTML = '<tr><td colspan="5" class="empty-row">Aucun contact</td></tr>';
    return;
  }
  tbody.innerHTML = contactsFiltered.map(c => {
    const extra = JSON.parse(c.extra_fields || '{}');
    const extraStr = Object.entries(extra).slice(0, 3).map(([k, v]) => `<span style="color:var(--muted)">${k}:</span> ${v}`).join(' Â· ');
    return `<tr>
      <td><strong>${c.name}</strong></td>
      <td>+${c.number}</td>
      <td style="color:var(--muted);font-size:11px">${extraStr || 'â€”'}</td>
      <td>${fmtDate(c.created_at)}</td>
      <td><div class="actions">
        <button class="btn btn-danger btn-xs" onclick="deleteContact(${c.id})">âœ•</button>
      </div></td>
    </tr>`;
  }).join('');
}

function filterContacts(q) {
  const lq = q.toLowerCase();
  contactsFiltered = allContacts.filter(c => c.name.toLowerCase().includes(lq) || c.number.includes(lq));
  renderContacts();
}

async function addContact() {
  const name = $('c-name').value.trim();
  const number = $('c-number').value.trim();
  if (!name || !number) return alert('Remplis tous les champs');
  const res = await api('POST', '/api/contacts', { name, number });
  if (res.error) return alert(res.error);
  $('c-name').value = ''; $('c-number').value = '';
  closeModal('modal-contact');
  loadContacts();
}

async function deleteContact(id) {
  if (!confirm('Supprimer ce contact ?')) return;
  await api('DELETE', `/api/contacts/${id}`);
  loadContacts();
}

// â”€â”€â”€ CSV Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleCSV(input) {
  const file = input.files[0];
  if (!file) return;
  const fd = new FormData();
  fd.append('csv', file);
  const res = await apiForm('/api/contacts/import', fd);
  const el = $('import-result');
  el.style.display = 'block';
  if (res.error) {
    el.style.background = 'rgba(255,77,77,0.06)';
    el.style.borderColor = 'rgba(255,77,77,0.15)';
    el.innerHTML = `âŒ Erreur : ${res.error}`;
    return;
  }
  el.style.background = 'rgba(37,211,102,0.06)';
  el.style.borderColor = 'rgba(37,211,102,0.15)';
  el.innerHTML = `âœ… ${res.imported} contact(s) importÃ©(s), ${res.skipped} ignorÃ©(s) (doublons)<br>
    <span style="color:var(--muted);font-size:11px">Variables custom dÃ©tectÃ©es : ${res.headers?.length ? res.headers.map(h => `<code>{{${h}}}</code>`).join(' ') : 'aucune'}</span>`;
  loadContacts();
  input.value = '';

  // Met Ã  jour les chips de variables
  if (res.headers?.length) {
    const chips = $('var-chips');
    chips.innerHTML = `
      <div class="var-chip" onclick="insertVar('name')">{{name}}</div>
      <div class="var-chip" onclick="insertVar('number')">{{number}}</div>
      ${res.headers.map(h => `<div class="var-chip" onclick="insertVar('${h}')">{{${h}}}</div>`).join('')}
    `;
  }
}

// Drag & drop
const zone = $('upload-zone');
zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag'); });
zone.addEventListener('dragleave', () => zone.classList.remove('drag'));
zone.addEventListener('drop', e => {
  e.preventDefault(); zone.classList.remove('drag');
  const file = e.dataTransfer.files[0];
  if (file?.name.endsWith('.csv')) {
    const dt = new DataTransfer(); dt.items.add(file);
    $('csv-input').files = dt.files;
    handleCSV($('csv-input'));
  }
});

// â”€â”€â”€ Campaigns â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCampaigns() {
  allCampaigns = await api('GET', '/api/campaigns');
  $('campaigns-count').textContent = allCampaigns.length + ' campagne' + (allCampaigns.length > 1 ? 's' : '');
  renderCampaigns();
}

function renderCampaigns() {
  const el = $('campaigns-list');
  if (!allCampaigns.length) {
    el.innerHTML = '<div class="card" style="text-align:center;color:var(--muted);padding:48px">Aucune campagne â€” crÃ©es-en une</div>';
    return;
  }
  el.innerHTML = allCampaigns.map(c => {
    const pct = c.total > 0 ? Math.round((c.sent / c.total) * 100) : 0;
    const scheduleStr = c.schedule_type === 'manual' ? 'Manuel' : c.schedule_type === 'spread'
      ? `Ã‰talÃ© ${c.spread_start}â€“${c.spread_end}` : `Quotidien Ã  ${c.schedule_time}`;

    return `<div class="card" style="margin-bottom:14px">
      <div style="display:flex;align-items:flex-start;gap:16px">
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
            <div style="font-size:15px;font-weight:800">${c.name}</div>
            <span class="badge ${c.status}">${c.status}</span>
          </div>
          <div style="font-size:12px;color:var(--muted);margin-bottom:12px;font-family:'DM Mono',monospace" class="truncate">${c.message}</div>
          <div style="display:flex;align-items:center;gap:20px;font-size:11px;color:var(--muted)">
            <span>ğŸ‘¥ ${c.total} contacts</span>
            <span style="color:var(--accent)">âœ… ${c.sent} envoyÃ©s</span>
            <span style="color:var(--red)">âŒ ${c.errors} Ã©checs</span>
            <span style="color:var(--yellow)">â³ ${c.pending} en attente</span>
            <span>ğŸ• ${scheduleStr}</span>
            <span>ğŸ“Š Max ${c.daily_limit}/jour</span>
          </div>
          ${c.total > 0 ? `<div class="progress-wrap mt-4" style="max-width:300px"><div class="progress-bar" style="width:${pct}%"></div></div>` : ''}
        </div>
        <div class="actions" style="flex-shrink:0;flex-wrap:wrap;justify-content:flex-end;max-width:200px">
          ${c.status !== 'running' ? `<button class="btn btn-primary btn-sm" onclick="sendNow(${c.id})">â–¶ Envoyer</button>` : '<span class="badge running">En coursâ€¦</span>'}
          ${c.schedule_type !== 'manual' && c.status !== 'active' ? `<button class="btn btn-yellow btn-sm" onclick="activateCampaign(${c.id})">âš¡ Activer</button>` : ''}
          <button class="btn btn-ghost btn-sm" onclick="editCampaign(${c.id})">âœï¸</button>
          <button class="btn btn-danger btn-sm" onclick="deleteCampaign(${c.id})">âœ•</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function openCampaignModal(campId = null) {
  editingCampId = campId;
  $('modal-camp-title').innerHTML = (campId ? 'Modifier' : 'Nouvelle') + ' campagne <button class="modal-close" onclick="closeModal(\'modal-campaign\')">Ã—</button>';
  $('save-camp-btn').textContent = campId ? 'Sauvegarder' : 'CrÃ©er la campagne';

  if (campId) {
    const c = allCampaigns.find(x => x.id === campId);
    $('camp-name').value = c.name;
    $('camp-message').value = c.message;
    $('camp-schedule-type').value = c.schedule_type;
    $('camp-limit').value = c.daily_limit;
    $('camp-time').value = c.schedule_time || '09:00';
    $('camp-start').value = c.spread_start || '09:00';
    $('camp-end').value = c.spread_end || '18:00';
    // Days
    const days = c.schedule_days || '1111111';
    document.querySelectorAll('.day-btn').forEach(btn => {
      btn.classList.toggle('on', days[btn.dataset.i] === '1');
    });
  } else {
    $('camp-name').value = ''; $('camp-message').value = '';
    $('camp-schedule-type').value = 'manual';
    $('camp-limit').value = 10; $('camp-time').value = '09:00';
    $('camp-start').value = '09:00'; $('camp-end').value = '18:00';
    document.querySelectorAll('.day-btn').forEach((btn, i) => btn.classList.toggle('on', i < 5));
  }

  // Populate contacts
  renderCampContacts('');
  updateScheduleUI();

  // Update var chips from contacts
  updateVarChips();

  openModal('modal-campaign');
}

function editCampaign(id) { openCampaignModal(id); }

function updateVarChips() {
  const chips = $('var-chips');
  // Collect all unique extra field keys from contacts
  const keys = new Set();
  allContacts.forEach(c => {
    try { Object.keys(JSON.parse(c.extra_fields || '{}')).forEach(k => keys.add(k)); } catch {}
  });
  chips.innerHTML = `
    <div class="var-chip" onclick="insertVar('name')">{{name}}</div>
    <div class="var-chip" onclick="insertVar('number')">{{number}}</div>
    ${[...keys].map(k => `<div class="var-chip" onclick="insertVar('${k}')">{{${k}}}</div>`).join('')}
  `;
}

function insertVar(key) {
  const ta = $('camp-message');
  const start = ta.selectionStart, end = ta.selectionEnd;
  const val = ta.value;
  ta.value = val.slice(0, start) + `{{${key}}}` + val.slice(end);
  ta.focus();
  ta.selectionStart = ta.selectionEnd = start + key.length + 4;
}

function renderCampContacts(filter) {
  const list = $('camp-contact-list');
  const filtered = allContacts.filter(c => !filter || c.name.toLowerCase().includes(filter.toLowerCase()) || c.number.includes(filter));
  if (!filtered.length) { list.innerHTML = '<div style="padding:12px;color:var(--muted);font-size:12px">Aucun contact</div>'; return; }

  // Get existing selection if editing
  let selected = new Set();
  document.querySelectorAll('#camp-contact-list input:checked').forEach(el => selected.add(+el.value));

  list.innerHTML = filtered.map(c => `
    <label class="contact-item">
      <input type="checkbox" value="${c.id}" ${selected.has(c.id) ? 'checked' : ''} onchange="updateSelectedCount()" />
      <span class="contact-name">${c.name}</span>
      <span class="contact-num">+${c.number}</span>
    </label>
  `).join('');
  updateSelectedCount();
}

function filterCampContacts(q) { renderCampContacts(q); }

function toggleAllContacts(checked) {
  document.querySelectorAll('#camp-contact-list input[type=checkbox]').forEach(el => el.checked = checked);
  updateSelectedCount();
}

function updateSelectedCount() {
  const n = document.querySelectorAll('#camp-contact-list input:checked').length;
  $('selected-count').textContent = n + ' contact' + (n > 1 ? 's' : '') + ' sÃ©lectionnÃ©' + (n > 1 ? 's' : '');
}

function updateScheduleUI() {
  const type = $('camp-schedule-type').value;
  $('schedule-options').style.display = type === 'manual' ? 'none' : 'block';
  $('fixed-time-opts').style.display = type === 'daily' ? 'block' : 'none';
  $('spread-opts').style.display = type === 'spread' ? 'block' : 'none';
}

function getDays() {
  const arr = ['0','0','0','0','0','0','0'];
  document.querySelectorAll('.day-btn.on').forEach(btn => arr[btn.dataset.i] = '1');
  return arr.join('');
}

document.querySelectorAll('.day-btn').forEach(btn => {
  btn.addEventListener('click', () => btn.classList.toggle('on'));
});

async function saveCampaign() {
  const name = $('camp-name').value.trim();
  const message = $('camp-message').value.trim();
  if (!name || !message) return alert('Nom et message requis');

  const contact_ids = [...document.querySelectorAll('#camp-contact-list input:checked')].map(el => +el.value);
  if (!contact_ids.length) return alert('SÃ©lectionne au moins un contact');

  const payload = {
    name, message, contact_ids,
    schedule_type: $('camp-schedule-type').value,
    schedule_time: $('camp-time').value,
    daily_limit: +$('camp-limit').value,
    schedule_days: getDays(),
    spread_over_day: $('camp-schedule-type').value === 'spread' ? 1 : 0,
    spread_start: $('camp-start').value,
    spread_end: $('camp-end').value
  };

  if (editingCampId) {
    await api('PATCH', `/api/campaigns/${editingCampId}`, payload);
  } else {
    await api('POST', '/api/campaigns', payload);
  }

  closeModal('modal-campaign');
  loadCampaigns();
}

async function sendNow(id) {
  if (!confirm('Envoyer maintenant les messages en attente ?')) return;
  const res = await api('POST', `/api/campaigns/${id}/send-now`);
  if (res.error) return alert(res.error);
  alert(`âœ… ${res.queued} message(s) mis en file d'attente`);
  loadCampaigns();
}

async function activateCampaign(id) {
  await api('POST', `/api/campaigns/${id}/activate`);
  loadCampaigns();
}

async function deleteCampaign(id) {
  if (!confirm('Supprimer cette campagne et tous ses logs ?')) return;
  await api('DELETE', `/api/campaigns/${id}`);
  loadCampaigns();
}

// â”€â”€â”€ Queue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadQueue() {
  const queue = await api('GET', '/api/queue');
  const tbody = $('queue-tbody');
  if (!queue.length) { tbody.innerHTML = '<tr><td colspan="5" class="empty-row">File vide</td></tr>'; return; }
  tbody.innerHTML = queue.map(q => `<tr>
    <td>${fmt(q.scheduled_for)}</td>
    <td>${q.contact_name}</td>
    <td>+${q.number}</td>
    <td>${q.campaign_name}</td>
    <td><span class="badge ${q.status}">${q.status}</span></td>
  </tr>`).join('');
}

// â”€â”€â”€ Logs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadLogs() {
  const logs = await api('GET', '/api/logs');
  const tbody = $('logs-tbody');
  if (!logs.length) { tbody.innerHTML = '<tr><td colspan="6" class="empty-row">Aucun log</td></tr>'; return; }
  tbody.innerHTML = logs.map(l => `<tr>
    <td>${fmt(l.sent_at)}</td>
    <td>${l.contact_name}</td>
    <td>+${l.number}</td>
    <td>${l.campaign_name}</td>
    <td><span class="badge ${l.status}">${l.status}</span></td>
    <td style="color:var(--red);font-size:11px">${l.error || ''}</td>
  </tr>`).join('');
}

// â”€â”€â”€ Connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadConnection() {
  const d = await api('GET', '/api/wa/status');
  const el = $('connection-content');

  if (d.status === 'ready') {
    el.innerHTML = `
      <div class="connected-box">
        <div class="connected-icon">âœ…</div>
        <div>
          <div class="connected-title">WhatsApp connectÃ©</div>
          <div class="connected-sub">Le bot est prÃªt. La session est sauvegardÃ©e et survivra aux redÃ©marrages.</div>
        </div>
      </div>
      <button class="btn btn-danger" onclick="disconnectWA()">DÃ©connecter</button>
    `;
  } else if (d.status === 'qr' && d.qr) {
    el.innerHTML = `
      <div class="qr-wrap">
        <img class="qr-img" src="${d.qr}" width="230" height="230" alt="QR" />
        <div>
          <div class="qr-title">Scanne ce QR code</div>
          <div class="qr-sub">WhatsApp â†’ â‹® Menu â†’ Appareils liÃ©s â†’ Lier un appareil</div>
        </div>
      </div>
    `;
    setTimeout(loadConnection, 3000);
  } else {
    el.innerHTML = `
      <div class="qr-wrap">
        <div style="font-size:52px">ğŸ”Œ</div>
        <div>
          <div class="qr-title">Non connectÃ©</div>
          <div class="qr-sub">Le serveur dÃ©marre WhatsAppâ€¦ Le QR code apparaÃ®tra dans quelques secondes.</div>
          <button class="btn btn-ghost mt-4" onclick="reconnectWA()">Forcer reconnexion</button>
        </div>
      </div>
    `;
    setTimeout(loadConnection, 4000);
  }
}

async function disconnectWA() {
  if (!confirm('DÃ©connecter WhatsApp ?')) return;
  await api('POST', '/api/wa/disconnect');
  loadConnection();
}

async function reconnectWA() {
  await api('POST', '/api/wa/reconnect');
  loadConnection();
}

// â”€â”€â”€ Modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id) { $(id).classList.add('open'); }
function closeModal(id) { $(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
});

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadAnalytics();
loadContacts();
</script>
</body>
</html>
